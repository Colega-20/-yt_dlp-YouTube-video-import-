<!-- @format -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouTube Music Downloader</title>
    <!-- Custom Styles -->
    <link
      rel="icon"
      href="https://cdn-icons-png.flaticon.com/64/16037/16037918.png "
      type="image/x-icon" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}" />
  </head>
  <body>
    <form id="download-form" class="from">
      <h1>YouTube Music Downloader</h1>
      <input
        type="text"
        name="youtube-url"
        id="youtube-url"
        class="link YouTube"
        placeholder="Inserte YouTube URL"
        oninput="showThumbnail()"
        required />
      <button type="button" class="Get" onclick="downloadAudio()">
        Obtener y Descargar
      </button>
      <!-- Contenedor para la miniatura -->
      <div id="thumbnail-container" style="margin-top: 20px; display: none">
        <img
          id="video-thumbnail"
          style="border-radius: 5px; max-width: 314px; width: 100%"
          alt="Video thumbnail" />
        <p id="video-title" style="margin-top: 10px; font-weight: bold"></p>
      </div>
      <div id="result"></div>
      <div class="marcas1">
        <div id="©">By Edisson © 2024. All rights reserved.</div>
      </div>
    </form>
    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: none">
      <div class="loading-content">
        <p>Procesando...</p>
      </div>
    </div>
    <canvas id="c"></canvas>
    <!-- Logica -->
    <script>
      // Función para extraer el ID del video de YouTube
      function getYouTubeVideoId(url) {
        const regExp =
          /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return match && match[2].length === 11 ? match[2] : null;
      }

      // Función para mostrar la miniatura
      function showThumbnail() {
        const url = document.getElementById("youtube-url").value;
        const videoId = getYouTubeVideoId(url);
        const thumbnailContainer = document.getElementById(
          "thumbnail-container"
        );
        const thumbnailImg = document.getElementById("video-thumbnail");

        if (videoId) {
          // Mostrar la miniatura
          thumbnailImg.src = `https://img.youtube.com/vi/${videoId}/0.jpg`;
          thumbnailContainer.style.display = "block";
          thumbnailImg.style.display = "block";
        } else {
          thumbnailContainer.style.display = "none";
          thumbnailImg.style.display = "none";
        }
      }

      async function downloadAudio() {
        const url = document.getElementById("youtube-url").value;

        // Mostrar overlay de carga
        document.getElementById("loading-overlay").style.display = "flex";

        const response = await fetch("/download", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ url }),
        });

        const result = await response.json();

        if (response.ok) {
          // Descargar automáticamente sin mostrar botón
          const decodedLink = decodeURIComponent(result.download_link);
          window.location.href = decodedLink;
        } else {
          document.getElementById(
            "result"
          ).innerHTML = `<p style="color: red;">Error: ${result.error}</p>`;
        }

        document.getElementById("youtube-url").value = ""; // Limpiar el input
        document.getElementById("video-thumbnail").style.display = "none";
        document.getElementById("thumbnail-container").style.display = "none";
        // Ocultar overlay de carga
        document.getElementById("loading-overlay").style.display = "none";
      }
    </script>

    <!-- Canva matrix -->
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <!-- Notas -->
    <script>
      const notas = {
        version: "Version del cliente: v1.0.3.2",
        versionB: "Version del Backend: v1.1.1",
        build: "Build: 2.5.2025",
        fecha: "Creacion: 13-11-2024",
        by: "By: Colega/Edisson",
      };

      console.log(notas["version"]);
      console.log(notas["versionB"]);
      console.log(notas["build"]);
      console.log(notas["fecha"]);
      console.log(notas["by"]);
    </script>
  </body>
</html>
